{% extends "base.html" %}

{% block title %}Dashboard - MAPSS{% endblock %}

{% block content %}
<main>
  <!-- HERO: Profile and quick links -->
  <form method="post" action="{% url 'toggle_privacy' %}" style="max-width:1200px;width:100%;margin:0 auto 14px;">
    {% csrf_token %}
    <div style="background:#141414;border:1px solid #2a2a2a;padding:18px;">
      <div style="display:flex;gap:16px;align-items:center;">
        {% if user_profile and user_profile.photo %}
          <img src="{{ user_profile.photo.url }}" alt="{{ request.user.username }}" style="width:84px;height:84px;object-fit:cover;border:1px solid #2a2a2a;">
        {% else %}
          <div style="width:84px;height:84px;display:flex;align-items:center;justify-content:center;border:1px solid #2a2a2a;background:#111;color:#aaa;font-size:1.6rem;">{{ request.user.username|slice:":1"|upper }}</div>
        {% endif %}
        <div style="flex:1;display:flex;justify-content:space-between;gap:12px;">
          <div>
            <h2 style="margin:0;color:#fff;">{{ request.user.first_name|default:request.user.username }}</h2>
            <div style="color:#cfcfcf;margin-top:2px;">{{ request.user.email }}</div>
            <div style="display:flex;gap:8px;margin-top:10px;">
              <a href="#chat" style="color:#ffce73;text-decoration:none;border:1px solid #2a2a2a;padding:6px 10px;">Chat</a>
              <a href="#tests-info" style="color:#ffce73;text-decoration:none;border:1px solid #2a2a2a;padding:6px 10px;">About Tests</a>
              <a href="#tests" style="color:#ffce73;text-decoration:none;border:1px solid #2a2a2a;padding:6px 10px;">Take Tests</a>
              <a href="#doctors" style="color:#ffce73;text-decoration:none;border:1px solid #2a2a2a;padding:6px 10px;">Doctors</a>
              <a href="#forum" style="color:#ffce73;text-decoration:none;border:1px solid #2a2a2a;padding:6px 10px;">Forum</a>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
            <span style="color:#eaeaea;">Privacy:</span>
            <strong style="color:#ffce73;">{{ is_anon|yesno:"Anonymous,Public" }}</strong>
            <button type="submit" class="btn-primary" style="max-width:none;width:auto;padding:8px 12px;border-radius:0;">Toggle</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- ABOUT TESTS (vertical) -->
  <div id="tests-info" style="max-width:900px;width:100%;margin:0 auto 14px;background:#171717;border:1px solid #2a2a2a;padding:12px;">
    <h3 style="color:#ffce73;margin:0 0 8px;letter-spacing:0.5px;">ABOUT TESTS</h3>
    <div style="display:grid;grid-template-columns:1fr;gap:8px;">
      <div style="border:1px solid #242424;padding:12px;background:#151515;color:#eaeaea;">
        <strong>PHQ-9</strong>
        <div style="color:#cfcfcf;margin-top:6px;">9 questions assessing depressive symptoms over the last 2 weeks.</div>
      </div>
      <div style="border:1px solid #242424;padding:12px;background:#151515;color:#eaeaea;">
        <strong>GAD-7</strong>
        <div style="color:#cfcfcf;margin-top:6px;">7 questions screening for generalized anxiety symptoms.</div>
      </div>
      <div style="border:1px solid #242424;padding:12px;background:#151515;color:#eaeaea;">
        <strong>Privacy</strong>
        <div style="color:#cfcfcf;margin-top:6px;">Reports save as Public or Anonymous based on your toggle (anon ID kept).</div>
      </div>
      <div style="border:1px solid #242424;padding:12px;background:#151515;color:#eaeaea;">
        <strong>Usage</strong>
        <div style="color:#cfcfcf;margin-top:6px;">Screening only; consult a professional for diagnosis.</div>
      </div>
    </div>
  </div>

  <!-- SECTION: Chat -->
  <div id="chat" style="max-width:1200px;width:100%;margin:0 auto 14px;background:#171717;border:1px solid #2a2a2a;padding:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #242424;padding-bottom:8px;margin-bottom:8px;">
      <h3 style="color:#ffce73;margin:0;letter-spacing:0.5px;">AI CHAT</h3>
      <small style="color:#cfcfcf;">Press Enter to send</small>
    </div>
    <div id="chat_box" style="height:320px;overflow:auto;border:1px solid #222;padding:8px;margin-bottom:8px;background:#111;">
      {% for m in chats %}
        <div style="margin-bottom:6px;color:#eaeaea;display:flex;gap:8px;">
          <div style="min-width:58px;color:#888;font-size:0.8rem;">{{ m.created_at|date:"H:i" }}</div>
          <div style="flex:1;">
            <strong>{{ m.is_user|yesno:"You,AI" }}{% if m.is_anonymous %} (Anon){% endif %}</strong>
            <div>{{ m.message }}</div>
          </div>
        </div>
      {% empty %}
        <div style="color:#aaa;">No messages yet. Say hello!</div>
      {% endfor %}
    </div>
    <div class="auth-grid">
      <div class="full">
        <label for="id_chat">Message</label>
        <input id="id_chat" name="message" placeholder="Type your message..." />
      </div>
    </div>
    <button type="button" id="ws_send" class="btn-primary">Send</button>
  </div>

  <!-- SECTION: Take tests (full width stacked) -->
  <div id="tests" style="max-width:900px;width:100%;margin:0 auto 14px;display:grid;grid-template-columns:1fr;gap:10px;">
    <a href="{% url 'phq9' %}" style="text-decoration:none;">
      <div style="background:#171717;border:1px solid #2a2a2a;padding:12px;color:#fff;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #242424;padding-bottom:6px;margin-bottom:6px;">
          <h3 style="color:#ffce73;margin:0;letter-spacing:0.5px;">PHQ-9</h3>
          <small style="color:#cfcfcf;">Screening</small>
        </div>
        <p style="color:#cfcfcf;">Assess depression symptoms. Saved as {{ is_anon|yesno:"Anonymous,Public" }}{% if is_anon %} (ID: {{ anon_id }}){% endif %}.</p>
      </div>
    </a>
    <a href="{% url 'gad7' %}" style="text-decoration:none;">
      <div style="background:#171717;border:1px solid #2a2a2a;padding:12px;color:#fff;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #242424;padding-bottom:6px;margin-bottom:6px;">
          <h3 style="color:#ffce73;margin:0;letter-spacing:0.5px;">GAD-7</h3>
          <small style="color:#cfcfcf;">Screening</small>
        </div>
        <p style="color:#cfcfcf;">Assess anxiety symptoms. Saved as {{ is_anon|yesno:"Anonymous,Public" }}{% if is_anon %} (ID: {{ anon_id }}){% endif %}.</p>
      </div>
    </a>
  </div>

  <!-- SECTION: Reports -->
  <div style="max-width:900px;width:100%;margin:0 auto 14px;background:#171717;border:1px solid #2a2a2a;padding:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #242424;padding-bottom:6px;margin-bottom:6px;">
      <h3 style="color:#ffce73;margin:0;letter-spacing:0.5px;">REPORTS</h3>
      <small style="color:#cfcfcf;">Recent</small>
    </div>
    <div style="overflow:auto;">
      <table style="width:100%;border-collapse:collapse;color:#eaeaea;">
        <thead>
          <tr style="text-align:left;color:#cfcfcf;">
            <th style="padding:8px;border-bottom:1px solid #242424;">Type</th>
            <th style="padding:8px;border-bottom:1px solid #242424;">Score</th>
            <th style="padding:8px;border-bottom:1px solid #242424;">When</th>
            <th style="padding:8px;border-bottom:1px solid #242424;">Mode</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
            <tr>
              <td style="padding:8px;border-bottom:1px solid #242424;">{{ r.test_type }}</td>
              <td style="padding:8px;border-bottom:1px solid #242424;">{{ r.score }}</td>
              <td style="padding:8px;border-bottom:1px solid #242424;">{{ r.created_at|date:"M d, Y H:i" }}</td>
              <td style="padding:8px;border-bottom:1px solid #242424;">{% if r.is_anonymous %}Anon ({{ r.anon_id|slice:":6" }}){% else %}Public{% endif %}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" style="padding:8px;color:#aaa;">No reports yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- DOCTORS (vertical list) -->
  <div id="doctors" style="max-width:900px;width:100%;margin:0 auto 14px;background:#171717;border:1px solid #2a2a2a;padding:12px;">
    <h3 style="color:#ffce73;margin:0 0 8px;letter-spacing:0.5px;">DOCTORS</h3>
    <div style="display:grid;grid-template-columns:1fr;gap:8px;">
      {% for d in doctors %}
        <div style="border:1px solid #242424;padding:12px;background:#151515;color:#eaeaea;display:flex;justify-content:space-between;gap:8px;">
          <div>
            <strong>{{ d.name }}</strong>{% if d.specialty %}<span style="color:#ffce73;"> ‚Äî {{ d.specialty }}</span>{% endif %}
            <div style="color:#cfcfcf;">{{ d.organization }}{% if d.city %}, {{ d.city }}{% endif %}</div>
          </div>
          <div style="white-space:nowrap;color:#cfcfcf;">{% if d.phone %}üìû {{ d.phone }}{% endif %}{% if d.email %} &nbsp;‚úâÔ∏è {{ d.email }}{% endif %}</div>
        </div>
      {% empty %}
        <div style="color:#aaa;">No contacts available yet.</div>
      {% endfor %}
    </div>
  </div>

  <div id="forum" style="max-width:900px;width:100%;margin:0 auto;background:#171717;border:1px solid #2a2a2a;padding:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #242424;padding-bottom:6px;margin-bottom:6px;">
      <h3 style="color:#ffce73;margin:0;letter-spacing:0.5px;">FORUM</h3>
      <small style="color:#cfcfcf;">Share with peers</small>
    </div>
    <div class="auth-grid">
      <div class="full">
        <label for="id_title">Title</label>
        <input id="id_title" name="title" placeholder="Share a thought or question" />
      </div>
      <div class="full">
        <label for="id_content">Content</label>
        <textarea id="id_content" name="content" rows="4" placeholder="Write your message"></textarea>
      </div>
    </div>
    <p style="color:#cfcfcf;margin-top:0.5rem;">Posting as {{ is_anon|yesno:"Anonymous,Public" }}{% if is_anon %} (ID: {{ anon_id }}){% endif %}</p>
    <button type="button" id="ws_post" class="btn-primary" style="border-radius:0;">Post</button>

    <div style="margin-top:12px;">
      <h4 style="color:#ffce73;margin:0 0 6px;">Your Posts</h4>
      {% for p in posts %}
        <div style="padding:8px 0;border-bottom:1px solid #242424;color:#eaeaea;">
          <strong>{{ p.title }}</strong> ‚Äî {{ p.created_at|date:"M d, Y H:i" }} {% if p.is_anonymous %}(Anon ID: {{ p.anon_id }}){% endif %}
          <div style="color:#cfcfcf;margin-top:0.25rem;">{{ p.content }}</div>
        </div>
      {% empty %}
        <div style="color:#aaa;">No posts yet.</div>
      {% endfor %}
    </div>
    <div style="margin-top:12px;">
      <h4 style="color:#ffce73;margin:0 0 6px;">Live Feed</h4>
      <div id="forum_feed" style="max-height:240px;overflow:auto;border:1px solid #222;padding:8px;background:#111;"></div>
    </div>
  </div>
</main>
{% endblock %}

<script>
  (function(){
    const isAnon = {{ is_anon|yesno:'true,false' }};
    const anonId = "{{ anon_id|default:'' }}";

    // Chat WS
    const chatSocket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/');
    const chatInput = document.getElementById('id_chat');
    const sendBtn = document.getElementById('ws_send');
    const chatBox = document.getElementById('chat_box');
    function appendChat(sender, message){
      const d = document.createElement('div');
      d.style.marginBottom = '6px';
      d.style.color = '#eaeaea';
      d.innerHTML = '<strong>' + sender + '</strong>: <span>' + (message||'') + '</span>';
      chatBox.appendChild(d);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function sendChat(){
      const msg = chatInput.value.trim();
      if(!msg || chatSocket.readyState !== WebSocket.OPEN) return;
      chatSocket.send(JSON.stringify({ message: msg, is_anonymous: isAnon, anon_id: anonId }));
      chatInput.value='';
    }
    sendBtn.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });
    chatSocket.onmessage = function(ev){
      try { const data = JSON.parse(ev.data); appendChat(data.sender === 'you' ? 'You' : 'AI', data.message); } catch(e){}
    };

    // Forum WS
    const forumSocket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/forum/');
    const postBtn = document.getElementById('ws_post');
    postBtn.addEventListener('click', function(){
      const t = document.getElementById('id_title').value.trim();
      const c = document.getElementById('id_content').value.trim();
      if(!t || !c || forumSocket.readyState !== WebSocket.OPEN) return;
      forumSocket.send(JSON.stringify({ title: t, content: c, is_anonymous: isAnon, anon_id: anonId }));
      document.getElementById('id_title').value = '';
      document.getElementById('id_content').value = '';
    });
    forumSocket.onmessage = function(ev){
      try {
        const data = JSON.parse(ev.data);
        const box = document.getElementById('forum_feed');
        if (!box) return;
        const el = document.createElement('div');
        el.style.marginBottom = '0.5rem';
        el.style.color = '#eaeaea';
        const author = data.author || (data.is_anonymous ? ('Anon-' + (data.anon_id||'').slice(0,6)) : 'User');
        el.innerHTML = '<strong>' + (data.title||'') + '</strong> ‚Äî <span style="color:#cfcfcf;">' + author + '</span><div style="color:#cfcfcf; margin-top:0.25rem;">' + (data.content||'') + '</div>';
        box.prepend(el);
      } catch (e) { }
    };
  })();
</script>


